## item45. 스트림은 주의해서 사용하라

- 스트림 API는 다량의 데이터 처리 작업을 돕고자 자바 8에 추가되었다

### 스트림 기본 개념
- 책에 스트림 개념이 너무나도 어렵게 나와있다
- 쉽게 설명하면
  - 스트림은 int, long, double 같은 데이터 원소를
  - 정렬하거나, 선택하거나, 변환하여 출력한다
- 스트림은 무한 시퀸스(sequence) 이다.
  - 스트림은 데이터를 저장하지 않는다
  - 특정한 계산, 변환 규칙에 따라 데이터를 흘러가게 한다

### 스트림 파이프라인
- 스트림 파이프라인은 소스 스트림에서 시작해 종단 연산(terminal operation)으로 끝난다
- 그 사이에 하나 이상의 중간 연산(intermediate operation)이 올 수 있다
  - 각 중간 연산은 스트림을 어떠한 방식으로든 변환 한다.
  - 연산 이후 타입이 같을 수도 다를 수도 있다
- 종단 연산은 마지막 중간 연산이 내놓은 스트림에 최후의 연산을 추가한다
  - 정렬해 컬렉션에 담거나
  - 특정 원소를 하나 선택하거나
  - 모든 원소를 출력하는 식이다.
```java
List<String> names = List.of("Alice", "Bob", "Charlie", "David");

names.stream()                           // 소스 스트림
    .filter(name -> name.length() > 3)  // 중간 연산
    .map(String::toUpperCase)           // 중간 연산
    .forEach(System.out::println);      // 종단 연산
```

### 지연 평가(Lazy Evaluation)
- 평가는 종단 연산이 호출될 때 이뤄진다. 
  - 즉, 쉽게 말하면, 중간 연산은 종단 연산이 호출될 때까지 아무 일도 하지 않는다
  - `filter`, `map` 같은 연산을 체인으로 연결해도, 실제 처리는 종단 연산이 호출될 때까지 지연(lazy) 된다.
- 스트림을 지연 평가 방식으로 처리하는 이유는 무엇일까
1. 필요 없는 연산을 피할 수 있다
```java
  List<String> names = List.of("Alice", "Bob", "Charlie", "David");

names.stream()
    .filter(name -> {
        System.out.println("filtering " + name);
        return name.length() > 3;
    })
.findFirst(); // 종단 연산
```
2. 스트림은 중간 연산에서 새 컬렉션을 만들지 않고 원소를 개별 처리한다. 고로, 메모리를 절약할 수 있다
3. 스트림은 내부적으로 중간 연산을 묶어서 한번에 처리한다

### 병렬 스트림
- 기본적으로 스트림 파이프라인은 순차적으로 수행된다.
- 병렬로 실행하려면 `parallel` 메서드를 호출해주면 된다.
- 병렬 스트림은 원소 처리를 여러 스레드가 나눠서 수행하고, 종단 연산에서 결과를 합쳐 최종 값을 생성한다
- 언제 써야할까?
  - 원소가 많고(수천~수백만)
  - 연산이 복잡하고 무거운 경우
  - ex. 이미지 처리, 큰 데이터 집계 등
- 원소가 적으면 오히려 스레드 관리 비용 때문에 느려질 수 있다
- 순서가 중요한 작업을 병렬 처리하면 순서과 바뀔 수 있다.

### 스트림을 언제 사용해야 하는가
- 스트림을 제대로 사용하면 프로그램이 짧고 깔끔해지지만, 잘못 사용하면 읽기 어렵고 유지보수도 힘들어진다
- 아나그램 어쩌구 저쩌구.. 별로 안중요하니까 넘어감
```java
import java.util.Scanner;

Map<String, Set<String>> groups = new HashMap<>();
try(Scanner s = new Scanner(dictionary)) {
    while (s.hasNext()) {
        String word = s.next();
        groups.computeIfAbsent(alphabetize(word),(unused) -> new TreeSet<>())
              .add(word);
    }
}
```
- `computeIfAbsent`를 사용해 각 키에 다수의 값을 담는 맵을 만들고 있다
- 하지만 스트림을 과용하면 프로그램이 읽거나 유지보수하기 어려워진다.
- 따라서 스트림을 사용하도록 하되, 새 코드가 더 나아 보일 때만 반영하자.

### 스트림을 사용할 때 주의할 점
- 람다 매개변수의 이름을 주의해서 지어야 한다
  - 매개변수 이름을 잘 지어야 스트림 파이프라인의 가독성이 유지된다
- 자바는 char용 스트림을 지원하지 않으므로, char 값들을 처리할 때는 스트림을 삼가는 편이 낫다
- 코드 블록을 사용해야만 할 때는 코드 블록을 사용하자
  - 범위 안의 지역변수를 읽고 수정해야할 때
  - return, break, continue 문이 필요할 때
  - 메서드 선언에 명시된 검사 예외를 던져야할 때

### 스트림을 사용하기 좋은 일들
- 원소들의 시퀸스를 일관되게 변환한다
- 원소들의 시퀸스를 필터링한다
- 원소들의 시퀸스를 하나의 연산을 사용해 결합한다
- 원소들의 시퀸스를 컬렉션에 모은다
- 원소들의 시퀸스에서 특정 조건을 만족하는 원소를 찾는다
- 스트림과 반복 중 어느 쪽이 나은지 확신하기 어렵다면 둘다 해보고 더 나은 쪽을 선택한다

